<div ng-controller="dataApprovalController">
    <div class="loading" ng-show="loading">
        <img src="img/ajax-loader.gif" class="spinner" />
    </div>
    <section class="panel tab-panel" ng-if="week &amp;&amp; currentModule">
        <div ng-show="isCompleted &amp;&amp; !isApproved &amp;&amp; !hasRoles(['Coordination Level Approver'])" class="alert alert-success">{{resourceBundle.firstLevelApproveSuccess}}</div>
        <div ng-show="isApproved &amp;&amp; !submitAndApprovalSuccess" class="alert alert-success">{{resourceBundle.secondLevelApproveSuccess}}</div>
        <div ng-show="approveError" class="alert alert-danger">{{resourceBundle.dataApproveFailure}}</div>
        <div class="alert alert-danger" ng-if="(!isApproved || !isCompleted) &amp;&amp; dataValues !== undefined &amp;&amp; (!isSubmitted || hasRoles(['Coordination Level Approver']) &amp;&amp;!isCompleted) &amp;&amp; hasRoles(['Project Level Approver', 'Coordination Level Approver'])">{{resourceBundle.noDataForApproval}}</div>
        <form name="dataentryForm" id="dataentry" ng-if="(isSubmitted &amp;&amp; hasRoles(['Project Level Approver'])) || (isCompleted &amp;&amp; hasRoles(['Coordination Level Approver']))">
            <div class="text-right">
                <input type="button" class="printTallySheetBtn" ng-click="printWindow()" value="{{resourceBundle.printTallySheetBtnValue}}" ng-show="currentModule"></input>
            </div>
            <accordion close-others="false">
                <accordion-group ng-repeat="(dataSetId, sections) in currentGroupedSections" is-open="getDatasetState(dataSetId, $first)[dataSetId]">
                    <accordion-heading>
                        <span ng-if="!resourceBundle[dataSetId]">{{ getDataSetName(dataSetId) }}</span>
                        <span ng-if="resourceBundle[dataSetId]">{{ resourceBundle[dataSetId] }}</span>
                        <i class="pull-left glyphicon" ng-class="{'glyphicon-chevron-down': isDatasetOpen[dataSetId], 'glyphicon-chevron-right': !isDatasetOpen[dataSetId]}"></i>
                    </accordion-heading>
                    <div class="exp-coll-group">
                        <accordion close-others="false">
                            <accordion-group ng-repeat="section in sections" is-open="isopen[section.id]" ng-form="sectionForm">
                                <div class='alert alert-danger' ng-show='sectionForm.$error.pattern'>
                                    <p>{{resourceBundle.invalidExpression}}</p>
                                </div>
                                <accordion-heading>
                                    <span ng-if="resourceBundle[section.id]">{{ resourceBundle[section.id] }}</span>
                                    <span ng-if="!resourceBundle[section.id]">{{ section.name }}</span>
                                    <i class="pull-left glyphicon" ng-class="{'glyphicon-chevron-down': isopen[section.id], 'glyphicon-chevron-right': !isopen[section.id]}"></i>
                                </accordion-heading>
                                <table class="table table-bordered" ng-if="isDatasetOpen[dataSetId] || printingTallySheet">
                                    <thead>
                                        <tr ng-repeat="category in section.headers">
                                            <th></th>
                                            <th ng-repeat="option in category track by $index" colspan="{{ maxcolumns(section.headers) / category.length}}">
                                                <span ng-if="!resourceBundle[option.id]">{{option.name}}</span>
                                                <span ng-if="resourceBundle[option.id]">{{resourceBundle[option.id]}}</span>
                                            </th>
                                            <th ng-hide="$last" class="last-column">
                                            </th>
                                            <th ng-show="$last" class="last-column">
                                                {{ resourceBundle.totalLabel }}
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr ng-repeat="dataElement in section.dataElements" ng-form="dataElementForm">
                                            <td>
                                                <span ng-if="resourceBundle[dataElement.id]"> {{ dataElement.formName }}</span>
                                                <span ng-if="!resourceBundle[dataElement.id]"> {{ dataElement.formName }}</span>
                                            </td>
                                            <td ng-repeat="option in section.categoryOptionComboIds">
                                                <ng-form ng-class="{'has-error': datavalueForm.datavalue.$invalid}" name="datavalueForm">
                                                    <input type="text" name="datavalue" id="datafield_{{$index}}" ng-value="getValue(dataValues, dataElement.id, option, section.orgUnits)" ng-disabled="true" />
                                                    <br/>
                                                </ng-form>
                                            </td>
                                            <td class="last-column">{{sum(dataValues, section.orgUnits, dataElement.id)}}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </accordion-group>
                        </accordion>
                    </div>
                </accordion-group>
                <accordion-group ng-repeat="(dataSetId, sections) in currentGroupedSectionsForOrigins" is-open="getDatasetState(dataSetId)[dataSetId]">
                    <accordion-heading>
                        <span ng-if="!resourceBundle[dataSetId]">{{ getDataSetName(dataSetId) }}</span>
                        <span ng-if="resourceBundle[dataSetId]">{{ resourceBundle[dataSetId] }}</span>
                        <i class="pull-left glyphicon" ng-class="{'glyphicon-chevron-down': isDatasetOpen[dataSetId], 'glyphicon-chevron-right': !isDatasetOpen[dataSetId]}"></i>
                    </accordion-heading>
                    <div class="exp-coll-group">
                        <accordion close-others="false">
                            <accordion-group ng-repeat="section in sections" is-open="isopen[section.id]" ng-form="sectionForm">
                                <div class='alert alert-danger' ng-show='sectionForm.$error.pattern'>
                                    <p>{{resourceBundle.invalidExpression}}</p>
                                </div>
                                <accordion-heading>
                                    <span ng-if="resourceBundle[section.id]">{{ resourceBundle[section.id] }}</span>
                                    <span ng-if="!resourceBundle[section.id]">{{ section.name }}</span>
                                    <i class="pull-left glyphicon" ng-class="{'glyphicon-chevron-down': isopen[section.id], 'glyphicon-chevron-right': !isopen[section.id]}"></i>
                                </accordion-heading>
                                <table class="table table-bordered" ng-if="isDatasetOpen[dataSetId] || printingTallySheet">
                                    <thead>
                                        <tr ng-repeat="category in section.headers">
                                            <th></th>
                                            <th ng-repeat="option in category track by $index" colspan="{{ maxcolumns(section.headers) / category.length}}">
                                                <span ng-if="!resourceBundle[option.id]">{{option.name}}</span>
                                                <span ng-if="resourceBundle[option.id]">{{resourceBundle[option.id]}}</span>
                                            </th>
                                            <th ng-hide="$last" class="last-column">
                                            </th>
                                            <th ng-show="$last" class="last-column">
                                                {{ resourceBundle.totalLabel }}
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody ng-repeat="orgUnit in section.orgUnits | orderBy: 'name'">
                                        <tr ng-repeat="dataElement in section.dataElements" ng-if="shouldDataBeEnteredForOrgUnit(orgUnit.id)" ng-form="dataElementForm">
                                            <td>
                                                <span ng-if="resourceBundle[orgUnit.id]"> {{resourceBundle[orgUnit.id]}}</span>
                                                <span ng-if="!resourceBundle[orgUnit.id]"> {{ orgUnit.name }}</span>
                                            </td>
                                            <td ng-repeat="option in section.categoryOptionComboIds">
                                                <ng-form ng-class="{'has-error': datavalueForm.datavalue.$invalid}" name="datavalueForm">
                                                    <input type="text" name="datavalue" id="datafield_{{$index}}" ng-value="getValue(dataValues, dataElement.id, option, orgUnit)" ng-disabled="true" />
                                                    <br/>
                                                </ng-form>
                                            </td>
                                            <td class="last-column">{{sum(dataValues, orgUnit ,dataElement.id)}}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </accordion-group>
                        </accordion>
                    </div>
                </accordion-group>
            </accordion>
            <div>
                <input type="button" class="btn btn-primary" ng-click="firstLevelApproval()" ng-disabled="dataentryForm.$invalid || isCompleted" ng-if="hasRoles(['Project Level Approver'])" value="{{resourceBundle.approveBtnValue}}" />
                <input type="button" class="btn btn-primary" ng-click="secondLevelApproval()" ng-disabled="dataentryForm.$invalid || isApproved" ng-if="hasRoles(['Coordination Level Approver'])" value="{{resourceBundle.approveBtnValue}}" />
            </div>
        </form>
    </section>
</div>
